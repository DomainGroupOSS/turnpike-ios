
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Filter Chains | Turnpike</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css"/>
    <link rel="stylesheet" href="_static/yammerdoc.css" type="text/css"/>
    <link rel="top" title="Turnpike" href="index.html"/>
    <link rel="next" title="Route Requests" href="requests.html"/>
    <link rel="prev" title="Mapping Routes to Callbacks" href="mapping-routes.html"/>
    <style lang="text/css">
        #top-bar, #top-bar small, #top-bar a {
            text-shadow: 0px -1px 0px #182127;
            color: #ffffff;
        }
        
        #top-bar {
            background-color: #363F45;
            background-image: -moz-linear-gradient(top, #545d63, #182127);
            background-image: -ms-linear-gradient(top, #545d63, #182127);
            background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#545d63), to(#182127));
            background-image: -webkit-linear-gradient(top, #545d63, #182127);
            background-image: -o-linear-gradient(top, #545d63, #182127);
            background-image: linear-gradient(top, #545d63, #182127);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#545d63', endColorstr = '#182127', GradientType = 0);
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
        }


        .hero-unit {
            background-image: url("_static/dropwizard-hat.png") !important;
            background-repeat: no-repeat !important;
            background-position: 30px 50px;
        }

        .hero-unit div.section {
            padding-left: 150px !important;
        }
    </style>
</head>
<body>
    <a href="https://github.com/URXtech/Turnpike">
        <img style="position: absolute; top: 0; right: 0; border: 0;"
             src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"
             alt="Fork me on GitHub"></a>
    <div class="navbar">
        <div class="navbar-inner container-fluid" id="top-bar">
            <header class="row-fluid">
                <h1 class="span12" id="title"><img class="logo" src="_static/turnpike-logo.png" alt="Logo"/>
                    <a href="index.html">Turnpike</a>
                    <small>Structuring the web of mobile apps.</small>
                </h1>
            </header>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span3" id="sidebar">
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Turnpike</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapping-routes.html">Mapping Routes to Callbacks</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Filter Chains</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#filter-usage">Filter Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-adding-a-filter">Example: Adding a Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performing-a-redirect-with-a-filter">Performing a Redirect with a Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-implementation">Filter Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filters-example">Filters Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#filter-chain">Filter Chain</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-inteface-with-the-filter-chain">How to inteface with the Filter Chain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-coupon-filter">Example: Coupon Filter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#anonymous-filters">Anonymous Filters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-use-anonymous-filter">How To Use Anonymous Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-uses-of-anonymous-filters">Example Uses of Anonymous Filters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requests.html">Route Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="resolving-routes.html">Resolving Routes</a></li>
</ul>

                <hr/>
            </div>
            <div class="span9" id="body">
                
  <div class="section" id="filter-chains">
<h1>Filter Chains</h1>
<p>Turnpike&#8217;s <tt class="docutils literal"><span class="pre">TPRouter</span></tt> internally keeps a list of filters, which you can append filters to, and which get invoked when a <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt> is created.</p>
<p>Filters allow you to perform logic with the incoming <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt> before the route&#8217;s mapped callback is invoked. Filters can be used for authentication, redirecting, analytics, and more.</p>
<div class="section" id="filter-usage">
<h2>Filter Usage</h2>
<p>Filters are used in a filter chain, and are executed sequentially. The sequence is defined by the order in which filters are added to the router (the first filter added is the first execute, the last is the last executed).</p>
<p>Filters can either be added with the method <tt class="docutils literal"><span class="pre">+</span> <span class="pre">(void)addFilter:(id</span> <span class="pre">&lt;TPFilterProtocol&gt;)filter</span></tt>, or they can be defined with a block and added with the method <tt class="docutils literal"><span class="pre">+</span> <span class="pre">(void)addAnonymousFilter:(TPFilterBlock)filterBlock</span></tt>.</p>
<div class="section" id="example-adding-a-filter">
<span id="examples-adding-a-filter"></span><h3>Example: Adding a Filter</h3>
<div class="highlight-objc"><div class="highlight"><pre><span class="p">[</span><span class="n">Turnpike</span> <span class="n">addAnonymousFilter</span><span class="o">:^</span><span class="p">(</span><span class="n">TPRouteRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">TPFilterChain</span> <span class="o">*</span><span class="n">filterChain</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Matched Route: %@&quot;</span><span class="p">,</span><span class="n">request</span><span class="p">.</span><span class="n">matchedRoute</span><span class="p">);</span>

    <span class="p">[</span><span class="n">filterChain</span><span class="p">.</span><span class="n">doFilterWithRequest</span><span class="o">:</span><span class="n">request</span><span class="p">];</span>
<span class="p">}];</span>
</pre></div>
</div>
<p>Filters themselves are objects that respond to <tt class="docutils literal"><span class="pre">TPFilterProtocol</span></tt>, and as such implement <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)</span> <span class="pre">doFilterWithRequest:(TPRouteRequest</span> <span class="pre">*)request</span> <span class="pre">AndFilterChain:(TPFilterChain</span> <span class="pre">*)filterChain</span></tt>. This is the method that is used to process a <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt>. In this method, the Filter should call either <tt class="docutils literal"><span class="pre">[filterChain.doFilterWithRequest:request]</span></tt> to continue the route, or invoke another route from the router to &#8220;redirect&#8221;. If the filter chain is not continued, it is forgotten and is ended.</p>
</div>
<div class="section" id="performing-a-redirect-with-a-filter">
<span id="examples-performing-a-redirect"></span><h3>Performing a Redirect with a Filter</h3>
<div class="highlight-objc"><div class="highlight"><pre><span class="p">[</span><span class="n">Turnpike</span> <span class="n">addAnonymousFilter</span><span class="o">:^</span><span class="p">(</span><span class="n">TPRouteRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">TPFilterChain</span> <span class="o">*</span><span class="n">filterChain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">([</span><span class="n">Sweepstakes</span> <span class="n">hasPlayed</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NO</span> <span class="o">&amp;&amp;</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">Turnpike</span> <span class="n">invokeInternalRoute</span><span class="o">:</span><span class="s">@&quot;sweepstakes/win&quot;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">filterChain</span><span class="p">.</span><span class="n">doFilterWithRequest</span><span class="o">:</span><span class="n">request</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">Sweepstakes</span> <span class="n">setHasPlayed</span><span class="o">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}];</span>
</pre></div>
</div>
<p>Filters allow you to perform logic with the incoming <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt> before the route&#8217;s mapped callback is invoked. Filters can be used for authentication, redirecting, analytics, and more.</p>
<p>Filters are used in a filter chain, and are executed sequentially. The sequence is defined by the order in which filters are added to the router (the first filter added is the first execute, the last is the last executed).</p>
<p>Filters themselves are objects that respond to <tt class="docutils literal"><span class="pre">TPFilterProtocol</span></tt>, and as such implement <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)</span> <span class="pre">doFilterWithRequest:(TPRouteRequest</span> <span class="pre">*)request</span> <span class="pre">AndFilterChain:(TPFilterChain</span> <span class="pre">*)filterChain</span></tt>. This is the method that is used to process a <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt>. In this method, the Filter should call either <tt class="docutils literal"><span class="pre">[filterChain.doFilterWithRequest:request]</span></tt> to continue the route, or invoke another route from the router to &#8220;redirect&#8221;. If the filter chain is not continued, it is forgotten and is ended.</p>
<p>Filters can either be added to a <tt class="docutils literal"><span class="pre">TPRouter</span></tt> with the method <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)addFilter:(id</span> <span class="pre">&lt;TPFilterProtocol&gt;)filter</span></tt>, or they can be defined with a block and added with the method <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)addAnonymousFilter:(TPFilterBlock)filterBlock</span></tt>.</p>
</div>
<div class="section" id="filter-implementation">
<h3>Filter Implementation</h3>
<p>To implement a filter, create a new object that responds to <tt class="docutils literal"><span class="pre">TPFilterProtocol</span></tt>. You must implement the method <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)</span> <span class="pre">doFilterWithRequest:(TPRouteRequest</span> <span class="pre">*)request</span> <span class="pre">AndFilterChain:(TPFilterChain</span> <span class="pre">*)filterChain</span></tt>, and if you want to continue the filter chain, at the end of your implementation you should call <tt class="docutils literal"><span class="pre">[filterChain.doFilterWithRequest:request]</span></tt>. You can also perform a &#8220;redirect&#8221; by invoking a new route and not calling <tt class="docutils literal"><span class="pre">[filterChain.doFilterWithRequest:request]</span></tt>.</p>
</div>
<div class="section" id="filters-example">
<h3>Filters Example</h3>
<div class="highlight-objc"><div class="highlight"><pre><span class="k">@implementation</span> <span class="nc">MyCouponFilter</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">doFilterWithRequest:</span><span class="p">(</span><span class="n">TPRouteRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">AndFilterChain:</span><span class="p">(</span><span class="n">TPFilterChain</span> <span class="o">*</span><span class="p">)</span><span class="nv">filterChain</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="n">valueForKey</span><span class="o">:</span><span class="s">@&quot;coupon_id&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">CouponProcessor</span> <span class="n">validateAndProcessCoupon</span><span class="o">:</span><span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="n">valueForKey</span><span class="o">:</span><span class="s">@&quot;coupon_id&quot;</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">filterChain</span><span class="p">.</span><span class="n">doFilterWithRequest</span><span class="o">:</span><span class="n">request</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="filter-chain">
<h2>Filter Chain</h2>
<p>The <tt class="docutils literal"><span class="pre">TPFilterChain</span></tt> is a queue of filters which get processed as its created. In processing each filter, the filter can decide to continue or abandon the filter chain. Should each filter continue the filter chain until there are no more filters left, the <tt class="docutils literal"><span class="pre">TPRoutingCallback</span></tt> associated with the route from the <tt class="docutils literal"><span class="pre">TPRouteRequest</span></tt> is invoked and the chain is complete.</p>
<div class="section" id="how-to-inteface-with-the-filter-chain">
<h3>How to inteface with the Filter Chain</h3>
<p>Filter chains are created by a <tt class="docutils literal"><span class="pre">TPRouter</span></tt> when a route or URL is invoked. The filters in the filter chain are supplied by the router in the order in which they were added to the router.</p>
<p>The typical way to interface with <tt class="docutils literal"><span class="pre">TPFilterChain</span></tt> is in your filter&#8217;s logic when creating a filter. In your filter logic, if you want to continue the filter chain with the current route, you need to call <tt class="docutils literal"><span class="pre">[filterChain</span> <span class="pre">doFilterWithRequest:request]</span></tt>. You should not need to call the <tt class="docutils literal"><span class="pre">TPFilterChain</span></tt>&#8216;s constructor, unless you are subclassing <tt class="docutils literal"><span class="pre">TPRouter</span></tt> in some special way.</p>
</div>
<div class="section" id="example-coupon-filter">
<h3>Example: Coupon Filter</h3>
<div class="highlight-objc"><div class="highlight"><pre><span class="k">@implementation</span> <span class="nc">MyCouponFilter</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">doFilterWithRequest:</span><span class="p">(</span><span class="n">TPRouteRequest</span> <span class="o">*</span><span class="p">)</span><span class="nv">request</span> <span class="nf">AndFilterChain:</span><span class="p">(</span><span class="n">TPFilterChain</span> <span class="o">*</span><span class="p">)</span><span class="nv">filterChain</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="n">valueForKey</span><span class="o">:</span><span class="s">@&quot;coupon_id&quot;</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">CouponProcessor</span> <span class="n">validateAndProcessCoupon</span><span class="o">:</span><span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">queryParameters</span> <span class="n">valueForKey</span><span class="o">:</span><span class="s">@&quot;coupon_id&quot;</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">filterChain</span><span class="p">.</span><span class="n">doFilterWithRequest</span><span class="o">:</span><span class="n">request</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="anonymous-filters">
<h2>Anonymous Filters</h2>
<p>The <tt class="docutils literal"><span class="pre">TPAnonymousFilter</span></tt> is an object which responds to the <tt class="docutils literal"><span class="pre">TPFilterProtocol</span></tt>, and which lets the user of this object define the behavior of the filter through a block.</p>
<p><tt class="docutils literal"><span class="pre">TPAnonymousFilter</span></tt> s are useful when making a filter to handle internal logic, where as creating your own class is useful when creating redistributable classes. The main advantage of <tt class="docutils literal"><span class="pre">TPAnonymousFilter</span></tt> s is being able to avoid the boilerplate required for creating a new class.</p>
<div class="section" id="how-to-use-anonymous-filter">
<h3>How To Use Anonymous Filter</h3>
<p>To use the <tt class="docutils literal"><span class="pre">TPAnonymousFilter</span></tt> you can either create a filter object with the factory method <tt class="docutils literal"><span class="pre">+</span> <span class="pre">(id&lt;TPFilterProtocol&gt;)</span> <span class="pre">filterWithBlock:(TPFilterBlock)filterBlock</span></tt>, or more conveniently, you can create them from your <tt class="docutils literal"><span class="pre">TPRouter</span></tt> by calling <tt class="docutils literal"><span class="pre">-</span> <span class="pre">(void)addAnonymousFilter:(TPFilterBlock)filterBlock</span></tt> or from <tt class="docutils literal"><span class="pre">Routable</span></tt> by calling <tt class="docutils literal"><span class="pre">+</span> <span class="pre">(void)addAnonymousFilter:(TPFilterBlock)filterBlock</span></tt>.</p>
</div>
<div class="section" id="example-uses-of-anonymous-filters">
<h3>Example Uses of Anonymous Filters</h3>
<div class="highlight-objc"><div class="highlight"><pre><span class="p">[</span><span class="n">Routable</span> <span class="n">addAnonymousFilter</span><span class="o">:^</span><span class="p">(</span><span class="n">TPRouteRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">TPFilterChain</span> <span class="o">*</span><span class="n">filterChain</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">matchedRoute</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">MyAwesomeLoggingService</span> <span class="n">logRoute</span><span class="o">:</span><span class="n">request</span><span class="p">.</span><span class="n">matchedRoute</span> <span class="n">WithParameters</span><span class="o">:</span><span class="n">request</span><span class="p">.</span><span class="n">routeParameters</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">filterChain</span> <span class="n">doFilterWithRequest</span><span class="o">:</span><span class="n">request</span><span class="p">];</span>
<span class="p">}];</span>
</pre></div>
</div>
</div>
</div>
</div>


            </div>
        </div>
        <hr/>
        <footer>
            &copy; Copyright 2013, URX.
            Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>
            1.2b1.
        </footer>
    </div>
</body>
</html>


